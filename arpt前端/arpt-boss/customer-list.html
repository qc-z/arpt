<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ARPT总裁管理后台系统</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/mycss-change.css">
    <link rel="stylesheet" href="css/3.css">
    <link rel="shortcut icon" href="images/favicon.ico" />
    <style>
        #out {
            width: 100%;
            color: #e8e8e8;
            margin-top: 1rem;
        }
        #out input{
            color: black;
        }
        #out>div{
            float: left;
            margin-top: 1rem;
        }
        .startinputdate, .endinputdate{
            margin-right: 1rem;
        }
        #startinputdate {
            margin-right: 2rem;
        }
        #confirm {
            line-height: 32px;
            display: inline-block;
            padding: 0 .5rem;
            color: #ec2f6f;
            margin-left: 2rem;
            border-radius: 20px;
            border: 2px solid #ec2f6f;
        }
    </style>
</head>
<body>
<!--<span class="part1-shadow"></span>-->
<div class="container-fluid">
    <nav class="navbar navbar-inverse navbar-fixed-top animated" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                        aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="javascript:;">ARPT总裁管理系统</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="basic-message.html">基本信息</a></li>
                    <li><a href="customer-list.html">客户列表</a></li>
                    <li><a href="project-management.html">项目管理</a></li>
                    <li><a href="data-manage.html">流量统计</a></li>
                    <li><a href="tools.html">拓客工具</a></li>
                    <li><a href="upload.html">广告图片管理</a></li>
                    <li><a href="account-change.html">修改密码</a></li>
                    <li><a href="#" class="s_signout">退出</a></li>
                </ul>
                <!--<form class="navbar-form navbar-right">-->
                <!--<input type="text" class="form-control" placeholder="Search...">-->
                <!--</form>-->
            </div>
        </div>
    </nav>
    <div class="nav-show">
        <div class="nav-shadow"></div>
        <div class=" col-sm-3 col-sm-offset-9 col-xs-5 col-xs-offset-7 nav-you">
            <div class="logo">
                <div class="col-sm-8 col-sm-offset-2 col-xs-8 col-xs-offset-2 pic">

                </div>
            </div>
            <ul class="nav-list ">
                <li><a href="basic-message.html">基本信息</a></li>
                <li><a href="customer-list.html">客户列表</a></li>
                <li><a href="project-management.html">项目管理</a></li>
                <li><a href="data-manage.html">流量统计</a></li>
                <li><a href="tools.html">拓客工具</a></li>
                <li><a href="upload.html" style="padding-left: 2rem;">广告图片管理</a></li>
                <li><a href="account-change.html">修改密码</a></li>
                <li><a href="#" class="s_signout">退出</a></li>
                <li><span>2016-2017@ARPT v1.2.7</span></li>
            </ul>
            <!--<p>2016-2017@ARPT</p>-->
            <!--<p>v1.0</p>-->
        </div>
    </div>

    <div class="row cus">
        <input class="col-xs-7 col-xs-offset-1 part1 tel"  placeholder="输入手机号码" id="inputmobile" type="text"/>
        <button style="margin-left: 2rem;" class="col-xs-2 col-xs-offset-1 btn3 change search" onclick="
            var temp=$('#inputmobile').val();
            if(temp === ''||temp.length!==11){
                layer.alert('请输入号码')
            }else{
            getUsers({p:0,c:0,m:temp})
            }">查询
        </button>
        <!-- <div class="col-xs-2 col-xs-offset-1 btn3 change search" style="position: absolute;top: 7.2%;left: 0%;" id="out"><a href="http://arpt.leglear.com:82/exportExel">导出用户数据</a></div> -->
        <div class="col-xs-10 part1-1">
            <div id="out">
                <div><span class="startinputdate">开始日期</span><input type="date" name="" id="startinputdate"></div>
                <div><span class="endinputdate">结束日期</span><input type="date" name="" id="endinputdate"></div>

                <div><a id="confirm" href="http://arpt.leglear.com:82/exportExel">确定导出</a></div>
            </div>
        </div>



        <div class="col-xs-10 part1-1">

            <button class="btn1 change all-cus" onclick="getUsers({p:0,c:0,m:''})">全部</button>
            <button class="btn2 change" onclick="getUsers({p:0,c:1,m:''})">颜值</button>
            <button class="btn2 change" onclick="getUsers({p:0,c:2,m:''})">皮肤</button>
            <button class="btn2 change" onclick="getUsers({p:0,c:3,m:''})">明星</button>
            <button class="btn2 change" onclick="getUsers({p:0,c:4,m:''})">到店</button>
        </div>
        <div id="title">
            <div id="users">
                <div id="user" class="col-xs-10 col-xs-offset-1 part2 animated fadeInUp" >
                    <span id="photo" class="photo"></span>
                    <span id="close" class="number close">x</span>
                    <span id="mobile" class="number"></span>
                    <span id="time" class="time"></span>
                    <!--<span id="last" class="time"></span>-->
                    <span id="origin_type" class="time"></span>
                    <span id="bring_user_count" class="time"></span><span id="num" class="time"></span>
                    <span class="check"><a id="view" href="">查看</a></span>
                </div>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li>
                        <a href="#" aria-label="Previous" onclick="getList(0)">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <!--<li><a href="" class="page-turn"  &lt;!&ndash;onclick="getList(2)&ndash;&gt;">1</a></li>-->
                    <!--<li><a href="" class="page-turn"  &lt;!&ndash;onclick="getList(2)&ndash;&gt;">2</a></li>-->
                    <!--<li><a href="" class="page-turn"  &lt;!&ndash;onclick="getList(2)&ndash;&gt;">3</a></li>-->
                    <!--<li><a href="" class="page-turn"  &lt;!&ndash;onclick="getList(2)&ndash;&gt;">4</a></li>-->
                    <!--<li><a href="" class="page-turn"  &lt;!&ndash;onclick="getList(2)&ndash;&gt;">5</a></li>-->
                    <li>
                        <a href="#" aria-label="Next" id="next" onclick="getList(1)">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script src="./script/jquery.js"></script>
<script src="./js/bootstrap.min.js"></script>
<script src="./script/bbmis.js"></script>
<script src="./layer/layer.js"></script>
<script src="./js/myjs.js"></script>
<script src="./js/moment.min.js"></script>
<script>
//导出某一个日期的数据
$("#endinputdate").change(function(){
    var startValue = $("#startinputdate").val();
    var endValue = $("#endinputdate").val();
    var href = "http://arpt.leglear.com:82/exportExel?queryStarDate="+startValue+"&queryEndDate="+endValue;
    $("#confirm").attr("href",href);
});

    var pagination = 0;
    var otherCondition = 0;
    var mobile = '';
    var temp = $("#user");

    function getUsers(options, cb) {
        var reqdata = {};
        pagination = options.p;
        otherCondition = options.c;
        mobile = options.m;
        reqdata.pagination = options.p || pagination;
        reqdata.otherCondition = options.c || otherCondition;
        reqdata.mobile = options.m || '';

        $.ajax({
            type: "POST",
            url: serve + "/getTestList",
            dataType: 'json',
            data: reqdata,
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (res) {
                console.log(res)

                var result = null;
                var result_face = null;
                var result_skin = null;
                var result_star = null;
                var result_shop = null;

                if (otherCondition === 0) {
                    console.log(res.results)
                    result_face = res.results[0];
                    result_skin = res.results[1];
                    result_star = res.results[2];


                    result_face.forEach(function (x) {
                        x.otherCondition = 1;
                    });
                    result_skin.forEach(function (x) {
                        x.otherCondition = 2;
                    });
                    result_star.forEach(function (x) {
                        x.otherCondition = 3;
                    });

                    result = result_face.concat(result_skin,result_star);
                } else if (otherCondition === 1) {
                    result = res.results;
                    result.forEach(function (x) {
                        x.otherCondition = 1;
                    });
                } else if (otherCondition === 2) {
                    result = res.results;
                    result.forEach(function (x) {
                        x.otherCondition = 2;
                    });
                } else if (otherCondition === 3) {
                    result = res.results;
                    console.log(result)
                    result.forEach(function (x) {
                        x.otherCondition = 3;
                    });
                }else if (otherCondition === 4) { // 到店测试包含颜值、皮肤、明星
                    console.log(res.results)
                    result_face = res.results[0];
                    result_skin = res.results[1];
                    result_star = res.results[2];

                    result_face.forEach(function (x) {
                        x.otherCondition = 1;
                    });
                    result_skin.forEach(function (x) {
                        x.otherCondition = 2;
                    });
                    result_star.forEach(function (x) {
                        x.otherCondition = 3;
                    });
                    result = result_face.concat(result_skin,result_star);
                }

                $("#users").html("");
                if (result.length === 0) {
                    layer.alert('没有结果');
                    return false
                }
                for (var i in result) {
                    var t = temp.clone();
                    var mobile1 = result[i].mobile;
                    // 图片兼容处理
                    if( result[i].image_path.indexOf('aliyuncs.com') == -1 ){
                        t.children("#photo").css('background-image', 'url("' + serve + '/' + result[i].image_path + '")');
                    }else{
                        t.children("#photo").css('background-image', 'url("' + result[i].image_path + '")');
                    }

                    t.children(".check").click(function () {
                        sessionStorage.setItem('mobile', $(this).parent().find("#mobile").html().replace("客户电话:", ""))
                    });
                    if (!mobile1) {
                        t.children("#mobile").html('用户未输入手机号码');
                    } else {
                        t.children("#mobile").html('客户电话:' + mobile1);
                    }
                    t.find('#close').attr({
                        'data-uuid': result[i].uuid,
                        'data-otherCondition': result[i].otherCondition
                    });
                    t.find('#close').unbind('click').click(function (e) {
                        var ele = $(e.target);
                        var c_uuid = ele.attr('data-uuid');
                        var c_otherCondition = ele.attr('data-otherCondition');

                        layer.confirm('确认删除吗？', {
                            btn: ['确认', '取消'] //按钮
                        }, function () {
                            $.ajax({
                                type: "GET",
                                url: serve + "/clientDeleteTestData",
                                dataType: 'json',
                                data: {
                                    uuid: c_uuid,
                                    otherCondition: c_otherCondition
                                },
                                xhrFields: {
                                    withCredentials: true
                                },
                                crossDomain: true,
                                success: function (res) {

                                    if (res.code == 1) {
                                        layer.msg(res.err, {icon: 1});
                                        getUsers({p: pagination, c: otherCondition, m: mobile});
                                    }
                                }
                            })
                        }, function () {
                        });
                    });
                    t.find('#time').html('访问日期:' + moment(result[i].meta.updatedAt).format("YYYY-MM-DD HH:mm"));
                    t.find('#last').html('最后检测:' + moment(result[i].last).format("YYYY-MM-DD HH:mm"));
                    t.find('#num').html('测试次数:' + result[i].testTimes);
                    t.find('#origin_type').html('客户来源:' + (result[i].originType === 'MO' ? "在线测试" : "到店测试"));
                    // t.find('#bring_user_count').html('带客量统计:' + result[i].bring_user_count);
                    t.find("#view").attr('href', "customer-message.html?uuid=" + result[i].uuid + '&otherCondition=' + result[i].otherCondition);
                    $("#users").append(t);
                }
                if (!!cb) cb(result);
            },
            error: function () {
            }
        });

    }

    function getList(p) {
        if (p === 1) {
            pagination++;
        } else {
            pagination--;
            if (pagination < 0) {
                layer.alert('已经是第一页');
                return false
            }
        }
        getUsers({p: pagination, c: otherCondition, m: mobile});
    }

    getUsers({p: 0, c: 0, m: ''});


        // $("#out").click(function(){
        //     $.ajax({
        //         type: "GET",
        //         url: serve + "/exportExel",
        //         dataType: 'json',
        //         xhrFields: {
        //             withCredentials: true
        //         },
        //         crossDomain: true,
        //         success: function (res) {

        //         }
        //     })
        // })


</script>

</body>
</html>
